<!DOCTYPE html>
  <html lang="ja">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>VisionTrainer Web - 反応速度向上トレーニング</title>
      <meta name="description" content="反応速度を鍛えるためのビジョントレーニン
  グアプリ。動く点に素早く反応してスコアを向上させよう。">

      <!-- Google AdSense -->
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygo
  ogle.js?client=ca-pub-1855366431586175" crossorigin="anonymous"></script>

      <style>
          body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
              background-color: #222;
              color: white;
              overflow: hidden;
          }

          .container {
              width: 100vw;
              height: 100vh;
              display: flex;
              flex-direction: column;
          }

          .ui-panel {
              background-color: #333;
              padding: 8px 15px;
              border-bottom: 1px solid #555;
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 10px;
              min-height: 60px;
          }

          .ui-left {
              display: flex;
              align-items: center;
              gap: 15px;
          }

          .ui-center {
              display: flex;
              align-items: center;
              gap: 10px;
          }

          .ui-right {
              display: flex;
              align-items: center;
              gap: 8px;
          }

          h1 {
              color: #6cf;
              margin: 0;
              font-size: 18px;
          }

          .timer {
              font-size: 20px;
              font-weight: bold;
              margin: 0;
              color: #fff;
          }

          .result {
              font-size: 14px;
              margin: 0;
              color: #6cf;
              min-width: 200px;
          }

          .canvas-container {
              position: relative;
              flex: 1;
              background-color: #111;
              overflow: hidden;
          }

          .dot {
              position: absolute;
              width: 60px;
              height: 60px;
              background-color: #6cf;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 30px;
              font-weight: bold;
              color: white;
              transition: background-color 0.1s;
          }

          .dot.signal {
              background-color: #f44;
          }

          button {
              padding: 6px 12px;
              margin: 0 2px;
              font-size: 12px;
              background-color: #444;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              transition: background-color 0.3s;
          }

          button:hover {
              background-color: #555;
          }

          .speed-btn.active {
              background-color: #6cf;
          }

          .start-btn {
              background-color: #2a5;
          }

          .start-btn:hover {
              background-color: #3b6;
          }

          .fullscreen-btn {
              background-color: #b25;
          }

          .fullscreen-btn:hover {
              background-color: #c36;
          }

          @media (max-width: 768px) {
              .ui-panel {
                  flex-direction: column;
                  gap: 5px;
              }

              .ui-left, .ui-center, .ui-right {
                  justify-content: center;
              }
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="ui-panel">
              <div class="ui-left">
                  <h1>VisionTrainer</h1>
                  <div class="timer" id="timer">Time: 02:00</div>
              </div>

              <div class="ui-center">
                  <div class="result" 
  id="result">Spaceキーで反応してください</div>
              </div>

              <div class="ui-right">
                  <button class="start-btn" id="startBtn">▶ Start</button>
                  <button class="speed-btn active" id="slowBtn">Slow</button>
                  <button class="speed-btn" id="normalBtn">Normal</button>
                  <button class="speed-btn" id="fastBtn">Fast</button>
                  <button id="historyBtn">History</button>
                  <button class="fullscreen-btn" id="fullscreenBtn">Large
  Screen</button>
              </div>
          </div>

          <div class="canvas-container" id="canvasContainer">
              <div class="dot" id="dot">0</div>
          </div>
      </div>

      <script>
          class VisionTrainer {
              constructor() {
                  this.sessionTime = 120;
                  this.counter = this.sessionTime;
                  this.running = false;
                  this.sessionDone = false;
                  this.speed = 1;
                  this.speeds = [0.5, 2.5, 4.5];
                  this.digitSpeeds = [2000, 1500, 1000];
                  this.waitingSignal = false;
                  this.signalTime = 0;
                  this.reactionTimes = [];
                  this.failCount = 0;
                  this.canvasSize = { width: 420, height: 240 };
                  this.dotRadius = 30;
                  this.maxReactionTime = 500;

                  this.initElements();
                  this.initEventListeners();

                  const mins = Math.floor(this.counter / 60);
                  const secs = this.counter % 60;
                  this.timerEl.textContent = `Time: 
  ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                  this.resultEl.textContent = 'Spaceキーで反応してください';

                  this.startDigitUpdate();
                  this.positionDot();

                  window.addEventListener('resize', () =>
  this.updateCanvasSize());
              }

              initElements() {
                  this.timerEl = document.getElementById('timer');
                  this.resultEl = document.getElementById('result');
                  this.canvasContainer =
  document.getElementById('canvasContainer');
                  this.dot = document.getElementById('dot');
                  this.startBtn = document.getElementById('startBtn');

                  this.dotPosition = {
                      x: this.canvasSize.width / 2,
                      y: this.canvasSize.height / 2
                  };
                  this.dotVelocity = { x: this.speeds[this.speed], y:
  this.speeds[this.speed] };

                  this.updateCanvasSize();
              }

              initEventListeners() {
                  this.startBtn.addEventListener('click', () => this.toggle());

                  document.getElementById('slowBtn').addEventListener('click',
  () => this.setSpeed(0));
                  document.getElementById('normalBtn').addEventListener('click',
   () => this.setSpeed(1));
                  document.getElementById('fastBtn').addEventListener('click',
  () => this.setSpeed(2));


  document.getElementById('fullscreenBtn').addEventListener('click', () =>
  this.toggleFullscreen());

  document.getElementById('historyBtn').addEventListener('click', () =>
  this.showHistory());

                  document.addEventListener('keydown', (e) => {
                      if (e.code === 'Space') {
                          e.preventDefault();
                          this.onSpace();
                      }
                  });
              }

              toggle() {
                  if (this.sessionDone) {
                      this.resetSession();
                      return;
                  }

                  this.running = !this.running;
                  this.startBtn.textContent = this.running ? '❚❚ Pause' : '▶ 
  Start';

                  if (this.running) {
                      if (this.counter === this.sessionTime) {
                          this.startTimer();
                          this.startMovement();
                          this.scheduleSignal();
                      } else {
                          this.resumeTimer();
                          this.startMovement();
                          if (!this.waitingSignal) {
                              this.scheduleSignal();
                          }
                      }
                  }
              }

              startTimer() {
                  const timerUpdate = () => {
                      if (!this.running) return;

                      if (this.counter <= 0) {
                          this.endSession();
                          return;
                      }

                      const mins = Math.floor(this.counter / 60);
                      const secs = this.counter % 60;
                      this.timerEl.textContent = `Time: 
  ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                      this.counter--;
                      setTimeout(timerUpdate, 1000);
                  };
                  timerUpdate();
              }

              resumeTimer() {
                  this.startTimer();
              }

              setSpeed(speedIndex) {
                  this.speed = speedIndex;
                  const baseSpeed = this.speeds[speedIndex];
                  this.dotVelocity.x = this.dotVelocity.x > 0 ? baseSpeed :
  -baseSpeed;
                  this.dotVelocity.y = this.dotVelocity.y > 0 ? baseSpeed :
  -baseSpeed;

                  this.startDigitUpdate();

                  document.querySelectorAll('.speed-btn').forEach(btn =>
  btn.classList.remove('active'));
                  document.getElementById(['slowBtn', 'normalBtn',
  'fastBtn'][speedIndex]).classList.add('active');
              }

              startMovement() {
                  const moveUpdate = () => {
                      if (!this.running) return;

                      this.dotPosition.x += this.dotVelocity.x;
                      this.dotPosition.y += this.dotVelocity.y;

                      if (this.dotPosition.x - this.dotRadius <= 0 ||
  this.dotPosition.x + this.dotRadius >= this.canvasSize.width) {
                          this.dotVelocity.x *= -1;
                      }
                      if (this.dotPosition.y - this.dotRadius <= 0 ||
  this.dotPosition.y + this.dotRadius >= this.canvasSize.height) {
                          this.dotVelocity.y *= -1;
                      }

                      this.positionDot();

                      if (this.running) {
                          requestAnimationFrame(moveUpdate);
                      }
                  };
                  moveUpdate();
              }

              positionDot() {
                  this.dot.style.left = (this.dotPosition.x - this.dotRadius) +
  'px';
                  this.dot.style.top = (this.dotPosition.y - this.dotRadius) +
  'px';
              }

              startDigitUpdate() {
                  if (this.digitInterval) {
                      clearInterval(this.digitInterval);
                  }

                  this.digitInterval = setInterval(() => {
                      if (!this.sessionDone) {
                          this.dot.textContent = Math.floor(Math.random() * 10);
                      }
                  }, this.digitSpeeds[this.speed]);
              }

              scheduleSignal() {
                  if (!this.running) return;

                  const delay = Math.random() * 2000 + 1000;
                  setTimeout(() => this.fireSignal(), delay);
              }

              fireSignal() {
                  if (!this.running) return;

                  this.dot.classList.add('signal');
                  this.waitingSignal = true;
                  this.signalTime = performance.now();
              }

              onSpace() {
                  if (this.sessionDone || !this.waitingSignal) return;

                  const reactionTime = performance.now() - this.signalTime;
                  const frames = Math.floor(reactionTime * 60 / 1000);

                  if (reactionTime > this.maxReactionTime) {
                      this.failCount++;
                  } else {
                      this.reactionTimes.push(reactionTime);
                  }

                  const rtText = reactionTime <= this.maxReactionTime ?
  `${Math.round(reactionTime)} ms, ${frames} f` : '';
                  this.resultEl.textContent = `RT: ${rtText}    Fail: 
  ${this.failCount}`;

                  this.dot.classList.remove('signal');
                  this.waitingSignal = false;
                  this.scheduleSignal();
              }

              endSession() {
                  this.running = false;
                  this.sessionDone = true;
                  this.startBtn.textContent = '▶ Reset';

                  if (this.digitInterval) {
                      clearInterval(this.digitInterval);
                  }

                  if (this.reactionTimes.length > 0) {
                      const avgMs = this.reactionTimes.reduce((a, b) => a + b,
  0) / this.reactionTimes.length;
                      const avgFps = 1000 / avgMs;
                      const avgFrames = Math.floor(avgMs * 60 / 1000);

                      this.resultEl.textContent = `2分終了 平均 FPS: 
  ${avgFps.toFixed(1)}, AvgFrames: ${avgFrames}f (${this.reactionTimes.length} 
  回), Fail: ${this.failCount}`;
                  } else {
                      this.resultEl.textContent = `2分終了 成功0回, Fail: 
  ${this.failCount}`;
                  }

                  this.saveRecord();
              }

              resetSession() {
                  this.running = false;
                  this.sessionDone = false;
                  this.counter = this.sessionTime;
                  this.waitingSignal = false;
                  this.reactionTimes = [];
                  this.failCount = 0;
                  this.startBtn.textContent = '▶ Start';
                  this.dot.classList.remove('signal');

                  const mins = Math.floor(this.counter / 60);
                  const secs = this.counter % 60;
                  this.timerEl.textContent = `Time: 
  ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                  this.resultEl.textContent = 'Spaceキーで反応してください';

                  this.dotPosition.x = this.canvasSize.width / 2;
                  this.dotPosition.y = this.canvasSize.height / 2;
                  this.positionDot();

                  this.startDigitUpdate();
              }

              saveRecord() {
                  const now = new Date().toLocaleString('ja-JP');
                  const avgMs = this.reactionTimes.length > 0 ?
  this.reactionTimes.reduce((a, b) => a + b, 0) / this.reactionTimes.length : 0;
                  const avgFps = avgMs > 0 ? 1000 / avgMs : 0;
                  const avgFrames = avgMs > 0 ? Math.floor(avgMs * 60 / 1000) :
  0;

                  const record = {
                      datetime: now,
                      averageFps: avgFps.toFixed(1),
                      averageFrames: avgFrames,
                      count: this.reactionTimes.length,
                      failures: this.failCount
                  };

                  let records =
  JSON.parse(localStorage.getItem('visionTrainerRecords') || '[]');
                  records.push(record);
                  localStorage.setItem('visionTrainerRecords',
  JSON.stringify(records));
              }

              toggleFullscreen() {
                  alert('フルスクリーン機能は開発中です');
              }

              updateCanvasSize() {
                  this.canvasSize.width = window.innerWidth;
                  this.canvasSize.height = window.innerHeight - 80;

                  this.dotPosition.x = this.canvasSize.width / 2;
                  this.dotPosition.y = this.canvasSize.height / 2;
                  this.positionDot();
              }

              showHistory() {
                  const records =
  JSON.parse(localStorage.getItem('visionTrainerRecords') || '[]');

                  if (records.length === 0) {
                      alert('まだ記録がありません');
                      return;
                  }

                  let historyText = '過去の記録:\n\n';
                  records.slice(-5).forEach(record => {
                      historyText += `${record.datetime}\n`;
                      historyText += `平均FPS: ${record.averageFps}, 成功: 
  ${record.count}回, 失敗: ${record.failures}回\n\n`;
                  });

                  alert(historyText);
              }
          }

          window.addEventListener('DOMContentLoaded', () => {
              new VisionTrainer();
          });
      </script>
  </body>
  </html>
